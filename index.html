<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Actualizar Inventario con Bit√°cora ‚Äì Zapata</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #00416A, #E4E5E6);
      color: #fff;
      text-align: center;
      padding: 40px;
    }
    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 25px;
      max-width: 550px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    input[type=file] {
      margin-top: 15px;
      padding: 8px;
      background: #fff;
      border-radius: 6px;
      color: #111;
    }
    button {
      margin-top: 20px;
      padding: 10px 25px;
      background: #0c6cbd;
      border: none;
      color: white;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { background: #1e88e5; }
    .progress-container {
      width: 100%;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      height: 22px;
      margin-top: 25px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: #00e676;
      transition: width 0.2s;
    }
    #status { margin-top: 15px; font-weight: 600; color: #ffeb3b; }
    #bitacora { text-align: left; margin-top: 25px; background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; font-size: 13px; }
    #bitacora h3 { margin: 10px 0 5px; font-size: 15px; color: #ffeb3b; }
    .ok { color: #00e676; }
    .warn { color: #ffb74d; }
    .err { color: #ff5252; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Actualizar inventario solo si hay cambios</h2>
    <p>Sube un Excel con columnas: <b>codigo, linea, descripcion, cantidad, costo</b></p>
    <input type="file" id="file" accept=".xlsx,.xls"><br>
    <button id="btnCargar">Cargar cambios</button>
    <div class="progress-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>
    <p id="status"></p>
    <button id="btnExportar" style="display:none;background:#43a047;">Descargar Bit√°cora</button>
    <div id="bitacora"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, doc, getDoc, updateDoc, setDoc,
    collection, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

  // === üî• CONFIGURACI√ìN FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.firebasestorage.app",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let rows = [];
  let bitacoraCambios = [];

  // === üì¶ Leer archivo Excel ===
  document.getElementById("file").addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return alert("Selecciona un archivo Excel.");
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(sheet);
    document.getElementById("status").textContent = `Archivo cargado: ${rows.length} productos detectados.`;
  });

  // === üöÄ Procesar actualizaci√≥n ===
  document.getElementById("btnCargar").addEventListener("click", async () => {
    if (rows.length === 0) return alert("Primero selecciona un archivo Excel v√°lido.");

    bitacoraCambios = [];
    let actualizados = 0, sinCambios = 0, noExisten = 0;
    const progressBar = document.getElementById("progressBar");
    const status = document.getElementById("status");
    const bitacora = document.getElementById("bitacora");
    bitacora.innerHTML = "";

    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];
      const codigo = (r.codigo || "").toString().trim();
      if (!codigo) continue;

      try {
        // ‚úÖ Buscar por campo "codigo" (no por ID)
        const q = query(collection(db, "almacenes", "almacen_zapata", "entradas"), where("codigo", "==", codigo));
        const querySnap = await getDocs(q);

if (querySnap.empty) {
  // üîπ Crear nuevo documento si no existe
  const nuevaRef = doc(collection(db, "almacenes", "almacen_zapata", "entradas"));
  const nuevoDoc = {
    codigo: codigo,
    linea: r.linea || "",
    descripcion: r.descripcion || "",
    cantidad: Number(r.cantidad) || 0,
    costo: Number(r.costo) || 0,
    fechaCreacion: new Date().toISOString()
  };
  await setDoc(nuevaRef, nuevoDoc);

  noExisten++;
  bitacoraCambios.push({ codigo, estado: "CREADO" });
  continue;
}


        const ref = querySnap.docs[0].ref;
        const dataActual = querySnap.docs[0].data();
        const cambios = {};
        const diferencias = [];

        if (r.linea && r.linea !== dataActual.linea) { cambios.linea = r.linea; diferencias.push("linea"); }
        if (r.descripcion && r.descripcion !== dataActual.descripcion) { cambios.descripcion = r.descripcion; diferencias.push("descripcion"); }
        if (r.cantidad && Number(r.cantidad) !== Number(dataActual.cantidad)) { cambios.cantidad = Number(r.cantidad); diferencias.push("cantidad"); }
        if (r.costo && Number(r.costo) !== Number(dataActual.costo)) { cambios.costo = Number(r.costo); diferencias.push("costo"); }

        if (Object.keys(cambios).length > 0) {
          await updateDoc(ref, cambios);
          actualizados++;
          bitacoraCambios.push({ codigo, estado: "ACTUALIZADO", cambios: diferencias.join(", ") });
        } else {
          sinCambios++;
          bitacoraCambios.push({ codigo, estado: "SIN CAMBIOS" });
        }

      } catch (err) {
        console.error("Error con c√≥digo:", codigo, err);
      }

      const progreso = Math.round(((i + 1) / rows.length) * 100);
      progressBar.style.width = progreso + "%";
      status.textContent = `Procesando ${i + 1}/${rows.length} ... ${progreso}%`;
      await new Promise(res => setTimeout(res, 30));
    }

    // === Mostrar resumen ===
    status.innerHTML = `
      ‚úÖ <b>${actualizados}</b> actualizados<br>
      üì¶ <b>${sinCambios}</b> sin cambios<br>
      ‚ùå <b>${noExisten}</b> no encontrados
    `;
    progressBar.style.background = "#00e676";

    const ok = bitacoraCambios.filter(b => b.estado === "ACTUALIZADO");
    const warn = bitacoraCambios.filter(b => b.estado === "SIN CAMBIOS");
    const err = bitacoraCambios.filter(b => b.estado === "NO ENCONTRADO");

    bitacora.innerHTML = `
      <h3>‚úÖ Actualizados (${ok.length})</h3>
      <div class="ok">${ok.map(b => `${b.codigo} (${b.cambios})`).join("<br>") || "Ninguno"}</div>
      <h3>üì¶ Sin cambios (${warn.length})</h3>
      <div class="warn">${warn.map(b => b.codigo).join("<br>") || "Ninguno"}</div>
      <h3>‚ùå No encontrados (${err.length})</h3>
      <div class="err">${err.map(b => b.codigo).join("<br>") || "Ninguno"}</div>
    `;

    document.getElementById("btnExportar").style.display = "inline-block";
  });

  // === üì§ Exportar bit√°cora a Excel ===
  document.getElementById("btnExportar").addEventListener("click", () => {
    if (bitacoraCambios.length === 0) return alert("No hay bit√°cora para exportar.");
    const hoja = XLSX.utils.json_to_sheet(bitacoraCambios);
    const libro = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(libro, hoja, "Bitacora");
    XLSX.writeFile(libro, "Bitacora_Actualizacion.xlsx");
  });
</script>
</body>
</html>
