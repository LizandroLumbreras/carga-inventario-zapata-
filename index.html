<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cargar Inventario Inicial – Almacén Zapata V2</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    #progressContainer {
        width: 100%;
        background: #ccc;
        height: 20px;
        border-radius: 10px;
        margin-top: 20px;
        display: none;
    }
    #progressBar {
        width: 0%;
        height: 100%;
        background: #00416A;
        border-radius: 10px;
        transition: width 0.2s linear;
    }
    #bitacora {
        margin-top: 20px;
        padding: 10px;
        background: #f4f4f4;
        height: 300px;
        overflow-y: scroll;
        border: 1px solid #aaa;
        font-family: Consolas, monospace;
        font-size: 14px;
    }
    #mensajeFinal {
        font-size: 20px;
        margin-top: 20px;
        display: none;
        color: green;
        font-weight: bold;
    }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
    getFirestore, doc, setDoc, collection, addDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore();

function log(texto) {
    const bit = document.getElementById("bitacora");
    bit.innerHTML += texto + "<br>";
    bit.scrollTop = bit.scrollHeight;
    console.log(texto);
}

window.cargarExcel = function(event) {
    const archivo = event.target.files[0];
    if (!archivo) {
        log("No se seleccionó archivo.");
        return;
    }

    log("Leyendo archivo: " + archivo.name);

    const reader = new FileReader();

    reader.onload = async function(e) {
        log("Archivo cargado en memoria, convirtiendo...");
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(hoja);

        log("Total de líneas encontradas en Excel: " + rows.length);

        document.getElementById("progressContainer").style.display = "block";
        document.getElementById("mensajeFinal").style.display = "none";

        const productos = [];

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];

            log("Procesando fila " + (i+1) + ": " + JSON.stringify(row));

            productos.push({
                codigoBarra: row.codigobarras,          // CLAVE PROVSOFT
                codigobarras: row.codigobarras,        // ORIGINAL
                descripcion: row.descripcion,
                cantidad: Number(row.cantidad),
                fecha: row.fecha,
                costoSinImpuesto: Number(row.costo_sin_impuesto),
                costo_sin_impuesto: Number(row.costo_sin_impuesto),
                linea: row.linea,
                movimiento: row.movimiento
            });

            actualizarBarra(i + 1, rows.length);

            await new Promise(resolve => setTimeout(resolve, 5));
        }

        log("Total productos convertidos: " + productos.length);

        await registrarInventarioInicial(productos);

        document.getElementById("mensajeFinal").innerHTML = 
          "✔ Inventario inicial cargado correctamente (" + productos.length + " productos)";
        document.getElementById("mensajeFinal").style.display = "block";
    };

    reader.readAsArrayBuffer(archivo);
};

function actualizarBarra(actual, total) {
    const porcentaje = Math.round((actual / total) * 100);
    document.getElementById("progressBar").style.width = porcentaje + "%";
    log("Progreso: " + porcentaje + "%");
}

async function registrarInventarioInicial(productos) {

    log("Creando almacén almacen_zapataV2...");

    const refAlmacen = doc(db, "almacenes", "almacen_zapataV2");
    await setDoc(refAlmacen, {
        nombre: "Almacén Zapata V2",
        creadoEn: serverTimestamp(),
        tipo: "almacen_fisico",
        estado: "activo"
    }, { merge: true });

    log("Almacén verificado/creado.");

    log("Creando documento de inventario inicial...");

    const entradasRef = collection(db, "almacenes", "almacen_zapataV2", "entradas");

    const docRef = await addDoc(entradasRef, {
        fecha: serverTimestamp(),
        tipo: "inventario_inicial",
        usuario: "Lizandro",
        productos: productos
    });

    log("Inventario inicial guardado con ID: " + docRef.id);
    log("Carga finalizada.");
}
</script>

</head>
<body>

<h2>Cargar Inventario Inicial – Almacén Zapata V2</h2>

<input type="file" accept=".xlsx,.xls" onchange="cargarExcel(event)">

<div id="progressContainer">
    <div id="progressBar"></div>
</div>

<div id="bitacora"></div>

<div id="mensajeFinal"></div>

</body>
</html>
